{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>{{ course.title }} - Course Content | Skillora</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    
    <!-- Favicon -->
    <link href="{% static 'img/icons/icon.png' %}" rel="icon">
    
    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Libraries Stylesheet -->
    <link href="{% static 'lib/animate/animate.min.css' %}" rel="stylesheet">
    <link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css' %}" rel="stylesheet">
    
    <!-- Customized Bootstrap Stylesheet -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    
    <!-- Template Stylesheet -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    
    <style>
        .material-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .material-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
        }
        .video-container iframe,
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .note-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body>
    <!-- Navbar Start -->
    <nav class="navbar navbar-expand-lg bg-white navbar-light shadow sticky-top p-0">
        <a href="{% url 'student_home' %}" class="navbar-brand d-flex align-items-center px-4 px-lg-5">
            <p class="m-0 fw-bold" style="font-size: 25px;"><img src="{% static 'img/icons/icon.png' %}" alt="" height="50px">Skill<span style="color: #fb873f;">ora</span> - Student</p>
        </a>
        <button type="button" class="navbar-toggler me-4" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" style="border: none;">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <div class="navbar-nav ms-auto p-4 p-lg-0">
                <a href="{% url 'student_home' %}" class="nav-item nav-link">Dashboard</a>
                <a href="{% url 'courses' %}" class="nav-item nav-link">Browse Skills</a>
                <a href="{% url 'cart' %}" class="nav-item nav-link">
                    <i class="fa fa-shopping-cart me-1"></i>Cart
                </a>
                <a href="{% url 'jobs' %}" class="nav-item nav-link">Jobs</a>
                <a href="{% url 'profile' %}" class="nav-item nav-link">Profile</a>
                <a href="{% url 'logout' %}" class="nav-item nav-link">Logout</a>
            </div>
        </div>
    </nav>
    <!-- Navbar End -->

    <!-- Course Content Start -->
    <div class="container-fluid py-5">
        <div class="container">
            <!-- Course Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="bg-primary text-white p-4 rounded">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div>
                                <h2 class="mb-2">{{ course.title }}</h2>
                                <p class="mb-0">{{ course.description|truncatechars:150 }}</p>
                                {% if course.instructor %}
                                <small class="d-block mt-2">
                                    <i class="fas fa-chalkboard-teacher me-1"></i>Instructor: {{ course.instructor.user.get_full_name|default:course.instructor.user.username }}
                                </small>
                                {% endif %}
                            </div>
                            <div class="text-end mt-3 mt-md-0">
                                <a href="{% url 'student_home' %}" class="btn btn-light">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            {% if progress %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Your Progress</h6>
                                <span class="fw-bold">{{ progress.progress_percentage|floatformat:1 }}%</span>
                            </div>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress.progress_percentage }}%;" aria-valuenow="{{ progress.progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ progress.progress_percentage|floatformat:1 }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Content Tabs -->
            <div class="row">
                <div class="col-12">
                    <ul class="nav nav-tabs" id="courseTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="materials-tab" data-bs-toggle="tab" data-bs-target="#materials" type="button" role="tab">
                                <i class="fas fa-book me-2"></i>Course Materials ({{ materials_with_status|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" type="button" role="tab">
                                <i class="fas fa-tasks me-2"></i>Assignments ({{ assignments.count }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="announcements-tab" data-bs-toggle="tab" data-bs-target="#announcements" type="button" role="tab">
                                <i class="fas fa-bullhorn me-2"></i>Announcements ({{ announcements.count }})
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-4" id="courseTabContent">
                        <!-- Materials Tab -->
                        <div class="tab-pane fade show active" id="materials" role="tabpanel">
                            {% if materials_with_status %}
                                <div class="row">
                                    {% for material_data in materials_with_status %}
                                    {% with material=material_data.material %}
                                    <div class="col-12 mb-4">
                                        <div class="card material-card shadow-sm {% if material_data.is_viewed %}border-success{% endif %}">
                                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    {% if material.material_type == 'video' %}
                                                        <i class="fas fa-video text-danger fa-2x me-3"></i>
                                                    {% elif material.material_type == 'note' %}
                                                        <i class="fas fa-sticky-note text-warning fa-2x me-3"></i>
                                                    {% elif material.material_type == 'file' %}
                                                        <i class="fas fa-file-pdf text-primary fa-2x me-3"></i>
                                                    {% else %}
                                                        <i class="fas fa-link text-info fa-2x me-3"></i>
                                                    {% endif %}
                                                    <div>
                                                        <h5 class="mb-0">
                                                            {{ material.title }}
                                                            {% if material_data.is_viewed %}
                                                                <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Done</span>
                                                            {% endif %}
                                                        </h5>
                                                        {% if material.description %}
                                                        <small class="text-muted">{{ material.description }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="d-flex align-items-center gap-2">
                                                    <small class="text-muted">{{ material.created_at|date:"M d, Y" }}</small>
                                                    {% if not material_data.is_viewed %}
                                                        <a href="{% url 'mark_material_done' material.id %}" class="btn btn-sm btn-success">
                                                            <i class="fas fa-check me-1"></i>Mark as Done
                                                        </a>
                                                    {% else %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-check me-1"></i>Completed
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                {% if material.material_type == 'video' %}
                                                    {% if material.youtube_video_id %}
                                                        <div id="video-wrapper-{{ material.id }}">
                                                            <div class="video-container mb-3" id="video-container-{{ material.id }}">
                                                                <iframe 
                                                                    id="youtube-iframe-{{ material.id }}"
                                                                    data-video-id="{{ material.youtube_video_id }}"
                                                                    data-standard-url="{{ material.get_youtube_standard_embed_url }}"
                                                                    data-privacy-url="{{ material.get_youtube_privacy_embed_url }}"
                                                                    src="{{ material.get_youtube_embed_url }}" 
                                                                    title="YouTube video player"
                                                                    frameborder="0" 
                                                                    referrerpolicy="strict-origin-when-cross-origin"
                                                                    loading="lazy"
                                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen"
                                                                    allowfullscreen
                                                                    style="width: 100%; height: 100%;">
                                                                </iframe>
                                                            </div>
                                                            <div class="alert alert-info mb-2" style="display: none;" id="video-error-{{ material.id }}">
                                                                <i class="fas fa-info-circle me-2"></i>
                                                                If the video doesn't load, click the button below to watch on YouTube.
                                                            </div>
                                                        </div>
                                                        <!-- Always show fallback link below video -->
                                                        <div class="mt-2 text-center">
                                                            <a href="{{ material.get_youtube_watch_url|default:material.url }}" target="_blank" class="btn btn-danger btn-lg">
                                                                <i class="fab fa-youtube me-2"></i>Watch on YouTube
                                                            </a>
                                                        </div>
                                                    {% elif material.file %}
                                                        <div class="video-container">
                                                            <video controls style="width: 100%; height: 100%;">
                                                                <source src="{{ material.file.url }}" type="video/mp4">
                                                                Your browser does not support the video tag.
                                                            </video>
                                                        </div>
                                                    {% elif material.url %}
                                                        {% with lower_url=material.url|lower %}
                                                        {% if lower_url|slice:'-4:' == '.pdf' %}
                                                        <div class="video-container" style="height: 600px;">
                                                            <iframe src="{{ material.url }}#toolbar=1" style="width:100%; height:100%; border:0;" title="PDF Viewer"></iframe>
                                                        </div>
                                                        {% else %}
                                                        <div class="text-center p-4">
                                                            <a href="{{ material.url }}" target="_blank" class="btn btn-primary btn-lg">
                                                                <i class="fab fa-youtube me-2"></i>Watch Video
                                                            </a>
                                                        </div>
                                                        {% endif %}
                                                        {% endwith %}
                                                    {% endif %}
                                                {% elif material.material_type == 'note' %}
                                                    <div class="note-content">
                                                        {{ material.content|linebreaks }}
                                                    </div>
                                                {% elif material.material_type == 'file' %}
                                                    {% if material.file %}
                                                        <div class="text-center p-4">
                                                            <i class="fas fa-file-pdf fa-4x text-primary mb-3"></i>
                                                            <p class="mb-3">{{ material.title }}</p>
                                                            <a href="{{ material.file.url }}" target="_blank" class="btn btn-primary">
                                                                <i class="fas fa-download me-2"></i>Download File
                                                            </a>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endwith %}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-book fa-4x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Materials Available Yet</h5>
                                    <p class="text-muted">Your instructor will upload course materials soon.</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Assignments Tab -->
                        <div class="tab-pane fade" id="assignments" role="tabpanel">
                            {% if assignments_with_submissions %}
                                <div class="row">
                                    {% for assignment_data in assignments_with_submissions %}
                                    <div class="col-12 mb-4">
                                        <div class="card shadow-sm h-100">
                                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-tasks text-warning me-2"></i>{{ assignment_data.assignment.title }}
                                                </h5>
                                                <span class="badge bg-primary">{{ assignment_data.assignment.get_assignment_type_display }}</span>
                                            </div>
                                            <div class="card-body">
                                                <p class="card-text">{{ assignment_data.assignment.description }}</p>
                                                
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <small class="text-muted d-block">
                                                            <i class="fas fa-calendar-alt me-1"></i><strong>Due Date:</strong>
                                                        </small>
                                                        <span class="{% if assignment_data.assignment.is_overdue %}text-danger{% else %}text-dark{% endif %}">
                                                            {{ assignment_data.assignment.due_date|date:"M d, Y g:i A" }}
                                                        </span>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small class="text-muted d-block">
                                                            <i class="fas fa-star me-1"></i><strong>Points:</strong>
                                                        </small>
                                                        <span class="text-primary fw-bold">{{ assignment_data.assignment.max_points }} points</span>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small class="text-muted d-block">
                                                            <i class="fas fa-clock me-1"></i><strong>Assigned:</strong>
                                                        </small>
                                                        <span class="text-muted">{{ assignment_data.assignment.assigned_date|date:"M d, Y" }}</span>
                                                    </div>
                                                </div>

                                                {% if assignment_data.assignment.attachment %}
                                                <div class="mb-3">
                                                    <small class="text-muted d-block mb-1"><strong>Attachment:</strong></small>
                                                    <a href="{{ assignment_data.assignment.attachment.url }}" class="btn btn-sm btn-outline-primary" download>
                                                        <i class="fas fa-download me-1"></i>Download Assignment File
                                                    </a>
                                                </div>
                                                {% endif %}

                                                <!-- Submission Status -->
                                                {% if assignment_data.submission_exists %}
                                                <div class="mb-3">
                                                    <div class="alert alert-{% if assignment_data.submission_status == 'graded' %}success{% elif assignment_data.submission_status == 'submitted' %}info{% else %}warning{% endif %}">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <strong>Submission Status:</strong> 
                                                                <span class="badge bg-{% if assignment_data.submission_status == 'graded' %}success{% elif assignment_data.submission_status == 'submitted' %}info{% else %}warning{% endif %}">
                                                                    {{ assignment_data.submission.get_status_display }}
                                                                </span>
                                                                {% if assignment_data.submission.submitted_at %}
                                                                    <br><small>Submitted: {{ assignment_data.submission.submitted_at|date:"M d, Y g:i A" }}</small>
                                                                {% endif %}
                                                                {% if assignment_data.submission.points_earned is not None %}
                                                                    <br><small><strong>Grade:</strong> {{ assignment_data.submission.points_earned }}/{{ assignment_data.assignment.max_points }} points</small>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% if assignment_data.submission.submission_file %}
                                                    <div class="mb-2">
                                                        <small class="text-muted d-block mb-1"><strong>Your Submission:</strong></small>
                                                        <a href="{{ assignment_data.submission.submission_file.url }}" class="btn btn-sm btn-outline-secondary" download>
                                                            <i class="fas fa-download me-1"></i>Download Your File
                                                        </a>
                                                    </div>
                                                    {% endif %}
                                                    {% if assignment_data.submission.feedback %}
                                                    <div class="mb-2">
                                                        <small class="text-muted d-block mb-1"><strong>Feedback:</strong></small>
                                                        <div class="alert alert-light">{{ assignment_data.submission.feedback }}</div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                {% endif %}

                                                <!-- Submit Button -->
                                                <div class="d-grid gap-2">
                                                    <a href="{% url 'submit_assignment' assignment_data.assignment.id %}" class="btn btn-{% if assignment_data.submission_exists %}outline-primary{% else %}primary{% endif %}">
                                                        <i class="fas fa-{% if assignment_data.submission_exists %}edit{% else %}upload{% endif %} me-2"></i>
                                                        {% if assignment_data.submission_exists %}Edit Submission{% else %}Submit Assignment{% endif %}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-tasks fa-4x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Assignments Yet</h5>
                                    <p class="text-muted">Your instructor will post assignments here.</p>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Announcements Tab -->
                        <div class="tab-pane fade" id="announcements" role="tabpanel">
                            {% if announcements %}
                                <div class="row">
                                    {% for announcement in announcements %}
                                    <div class="col-12 mb-3">
                                        <div class="card shadow-sm {% if announcement.is_important %}border-warning{% endif %}">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h5 class="mb-2">
                                                            {% if announcement.is_important %}
                                                            <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                                            {% else %}
                                                            <i class="fas fa-bullhorn text-info me-2"></i>
                                                            {% endif %}
                                                            {{ announcement.title }}
                                                        </h5>
                                                        <p class="text-muted mb-2">{{ announcement.content|linebreaks }}</p>
                                                        <small class="text-muted">{{ announcement.created_at|date:"M d, Y g:i A" }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-bullhorn fa-4x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Announcements Yet</h5>
                                    <p class="text-muted">Your instructor will post announcements here.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Course Content End -->

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-light footer pt-5 mt-5 wow fadeIn" data-wow-delay="0.1s">
        <div class="container py-5">
            <div class="row g-5">
                <div class="col-lg-4 col-md-6">
                    <h4 class="text-white mb-3">Quick Link</h4>
                    <p><a class="text-light" href="{% url 'about' %}">About Us</a></p>
                    <p><a class="text-light" href="{% url 'contact' %}">Contact Us</a></p>
                </div>
                <div class="col-lg-4 col-md-6">
                    <h4 class="text-white mb-3">Contact</h4>
                    <p class="mb-2"><i class="fa fa-envelope me-3"></i>skillora@gmail.com</p>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="copyright">
                <div class="row">
                    <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                        &copy; <a class="border-bottom" href="{% url 'home' %}">Skillora</a>, All Right Reserved.
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="bi bi-arrow-up"></i></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'lib/wow/wow.min.js' %}"></script>
    <script src="{% static 'lib/easing/easing.min.js' %}"></script>
    <script src="{% static 'lib/waypoints/waypoints.min.js' %}"></script>
    <script src="{% static 'lib/owlcarousel/owl.carousel.min.js' %}"></script>

    <!-- Template Javascript -->
    <script src="{% static 'js/main.js' %}"></script>
    
    <!-- YouTube Error Handling Script -->
    <script>
        // Improve reliability of YouTube embeds and provide fallbacks
        document.addEventListener('DOMContentLoaded', function() {
            const iframes = document.querySelectorAll('iframe[id^="youtube-iframe-"]');
            
            iframes.forEach(function(iframe) {
                const videoId = iframe.getAttribute('data-video-id');
                const standardUrl = iframe.getAttribute('data-standard-url');
                const privacyUrl = iframe.getAttribute('data-privacy-url');
                const errorDiv = document.getElementById('video-error-' + videoId);
                
                // If the player loads with an error overlay, the 'load' event still fires.
                // We therefore perform a timed swap to the alternate domain if the user
                // hasnâ€™t interacted and the frame size remains zeroed for too long.
                let swappedOnce = false;
                const trySwap = (targetUrl) => {
                    if (swappedOnce || !targetUrl) return;
                    swappedOnce = true;
                    iframe.src = targetUrl;
                    if (errorDiv) errorDiv.style.display = 'block';
                };

                // Timed fallback: if the frame hasn't painted within 2s, try privacy domain
                const timer = setTimeout(() => {
                    // First, if current is standard, try privacy; else try standard
                    if (iframe.src.includes('youtube.com/embed/') && privacyUrl) {
                        trySwap(privacyUrl);
                    } else if (standardUrl) {
                        trySwap(standardUrl);
                    }
                }, 2000);

                // Successful load: hide error UI and cancel timer
                iframe.addEventListener('load', function() {
                    clearTimeout(timer);
                    if (errorDiv) errorDiv.style.display = 'none';
                });
                
                // Network error handler: swap domains once
                iframe.addEventListener('error', function() {
                    if (iframe.src.includes('nocookie') && standardUrl) trySwap(standardUrl);
                    else if (privacyUrl) trySwap(privacyUrl);
                });
            });
        });
    </script>
</body>
</html>

